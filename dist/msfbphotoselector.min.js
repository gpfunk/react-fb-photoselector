/**
 * @license MIT
 * @author Michael Scharl <michael.scharl@me.com>
 */
"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(e,t){if("object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module)module.exports=e(require("react"));else if("function"==typeof define&&define.amd)define(["react"],e);else{var o;if("undefined"!=typeof window)o=window;else if("undefined"!=typeof global)o=global;else{if("undefined"==typeof self)return console&&console.error&&void 0;o=self}o[t]=e(o.React)}}(function(e){var t,o={CONNECTION_FAILED:{code:-1,message:"could not connect to fb"},NO_ALBUMS:{code:1,message:"could not load albums from user"},NO_PHOTOS:{code:2,message:"could not load photos from album"}};return t=e.createClass({displayName:"MSFBPhotoSelector",statics:{TEXTS:{your_albums:"Your Albums",show_more:"Show more",loading:"Loadingâ€¦",connection_failed:"Failed to connect to Facebook.",could_not_load_albums:"Albums couldn't be loaded.",could_not_load_album_photos:"Data for this album could not be loaded.",could_not_select_photo:"Failed to select the photo.",close:"Close"},ERROR:o,ALBUM_PHOTOS_LIMIT:6,ALBUM_PHOTOS_ROWS_TO_ADD:3},propTypes:{closeOnEsc:e.PropTypes.bool,closeOnOutsideClick:e.PropTypes.bool,onError:e.PropTypes.func,onCancel:e.PropTypes.func.isRequired,onSelect:e.PropTypes.func.isRequired},getInitialState:function(){return{FB_user_picture_url:"",FB_albums:[],FB_accessToken:"",initializing:!0,selectedPhoto:0,selectingPhoto:!1,showErrorMessage:!1,errorMessageLink:"",errorMessage:""}},getDefaultProps:function(){return{closeOnEsc:!0,closeOnOutsideClick:!0,onError:function(){return null}}},componentDidMount:function(){var e=this;e._manageGlobalEventHandlers(e.props),e._FB_init(function(){e.setState({initializing:!1})})},componentWillUnmount:function(){this._manageGlobalEventHandlers({},!0)},componentWillReceiveProps:function(e){this._manageGlobalEventHandlers(e)},_manageGlobalEventHandlers:function(e,t){var o=this;!t&&e.closeOnEsc?document.addEventListener("keyup",o.onKeyup_document):document.removeEventListener("keyup",o.onKeyup_document),!t&&e.closeOnOutsideClick?document.addEventListener("click",o.onClick_document):document.removeEventListener("click",o.onClick_document)},_FB_init:function(e){var r=this;if("undefined"==typeof FB)throw new Error("FB-SDK was not found!");FB.getLoginStatus(function(n){"connected"!=n.status?(r.props.onError(o.CONNECTION_FAILED),r.set_errorMessage(t.TEXTS.connection_failed)):(r.setState({FB_accessToken:n.authResponse.accessToken}),r._FB_getUserAlbums(e),r._FB_getUserImage())},!0)},_FB_getUserImage:function(){var e=this;e._FB_API("/me/picture",function(t){e.setState({FB_user_picture:t.data.url})})},_FB_getUserAlbums:function(e){var r=this;r._FB_API("/me/albums",{fields:"name,id"},function(n){!n||n.error?(r.props.onError(o.NO_ALBUMS),r.set_errorMessage(t.TEXTS.could_not_load_albums)):r.setState({FB_albums:n.data.map(function(e){var e={id:e.id,name:e.name,loading:!1,limit:t.ALBUM_PHOTOS_LIMIT,photos:[]};return r._FB_getAlbumPhotos(e),e})},e)})},_FB_getAlbumPhotos:function(e){var r=this;r._FB_API("/"+e.id+"/photos",{fields:"id",limit:999999},function(n){if(!n||n.error)r.props.onError(o.NO_PHOTOS),r.set_errorMessage(t.TEXTS.could_not_load_album_photos,"https://facebook.com/"+e.id);else{var s=r.state.FB_albums.indexOf(e),a=r.state.FB_albums.slice(0);a[s].photos=n.data.map(function(e){return{id:e.id}}),r.setState({FB_albums:a})}})},_FB_getPhoto:function(e,t){var o=this;o._FB_API("/"+e+"/picture",t)},_FB_API:function(e,t,o){if("undefined"==typeof FB)throw new Error("FB-SDK was not found!");FB.api(e,t,o)},onKeyup_document:function(e){27==e.keyCode&&this.onClick_cancel()},onClick_document:function(e){e.defaultPrevented||this.onClick_cancel()},onClick_cancel:function(){this.props.onCancel()},onClick_photo:function(e){var t=this;t.setState({selectedPhoto:e.id,selectingPhoto:!0},function(){return t._FB_getPhoto(e.id,function(o){t.props.onSelect({id:e.id,url:o.data.url})})})},onClick_showMorePhotos:function(e){var o=this,r=o.state.FB_albums.slice(),n=r.indexOf(e);r[n].limit+=t.ALBUM_PHOTOS_LIMIT*t.ALBUM_PHOTOS_ROWS_TO_ADD,o.setState({FB_albums:r})},set_errorMessage:function(e,t,o){var r=this;r.setState({showErrorMessage:"undefined"==typeof link?1:2,errorMessage:e,errorMessageLink:t},function(){return setTimeout(function(){return r.setState({showErrorMessage:!1,errorMessage:"",errorMessageLink:""})},o||4e3)})},render:function(){return this.renderPart_popup()},renderPart_popup:function(){var t=this;return e.createElement("div",{className:"ms-fbphotoselector__popup"},e.createElement("div",{className:"ms-fbphotoselector"},t.renderPart_header(),e.createElement("div",{className:"ms-fbphotoselector__content"},t.renderPart_error(),t.state.initializing?t.renderPath_loading():t.renderPart_albums()),t.renderPart_footer(),t.state.selectingPhoto?e.createElement("div",{className:"ms-fbphotoselector__content__overlay"}):null))},renderPart_header:function(){var o=this;return e.createElement("div",{className:"ms-fbphotoselector__header"},o.state.FB_user_picture_url?e.createElement("img",{src:o.state.user_picture,className:"ms-fbphotoselector__header__user-image"}):null,e.createElement("i",{className:"ms-fbphotoselector__header__icon"}),t.TEXTS.your_albums)},renderPart_footer:function(){var o=this;return e.createElement("div",{className:"ms-fbphotoselector__footer"},e.createElement("a",{onClick:o.onClick_cancel},t.TEXTS.close))},renderPath_loading:function(){return e.createElement("div",{className:"ms-fbphotoselector__loader"},t.TEXTS.loading)},renderPart_albums:function(){var o=this,r=o.state.FB_albums.filter(function(e){return!!e.photos.length});return e.createElement("ul",{className:"ms-fbphotoselector__albums"},r.map(function(r){return e.createElement("li",{key:r.id,className:"ms-fbphotoselector__albums__item"},e.createElement("h3",{className:"ms-fbphotoselector__albums__item-name"},r.name),e.createElement("ul",{className:"ms-fbphotoselector__albums__photos"},r.photos.slice(0,r.limit).map(o.renderPart_photo)),r.limit<r.photos.length?e.createElement("button",{className:"ms-fbphotoselector__albums__item-more",onClick:function(){return o.onClick_showMorePhotos(r)}},t.TEXTS.show_more):null)}))},renderPart_photo:function(t){var o=this,r={backgroundImage:"url('https://graph.facebook.com/"+t.id+"/picture?type=album&access_token="+o.state.FB_accessToken+"')"},n=["ms-fbphotoselector__albums__photos-image__image",o.state.selectedPhoto==t.id&&"ms-fbphotoselector__albums__photos-image__image--selected"];return e.createElement("li",{key:t.id,className:"ms-fbphotoselector__albums__photos-image"},e.createElement("div",{className:n.join(" "),onClick:function(){return o.onClick_photo(t)},style:r}))},renderPart_error:function(){var t=this,o=["ms-fbphotoselector__error",t.state.showErrorMessage&&"ms-fbphotoselector__error--visible"];return t.state.showErrorMessage?e.createElement("div",{className:o.join(" ")},e.createElement("span",{className:"ms-fbphotoselector__error__icon"}),2!=t.state.showErrorMessage?e.createElement("span",{className:"ms-fbphotoselector__error__text"},t.state.errorMessage):e.createElement("a",{href:t.state.errorMessageLink,target:"_blank",className:"ms-fbphotoselector__error__text"},t.state.errorMessage)):null}})},"MSFBPhotoSelector");